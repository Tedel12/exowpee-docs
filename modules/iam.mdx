
## Overview

The IAM module (Identity & Access Management) is the core system for handling user identities, authentication, and access control in the Exowpee platform. Its primary purpose is to ensure secure user login, registration, role-based access control (RBAC), and permission management across multi-tenant companies. This module provides the foundation for all other modules, as it handles authentication tokens and user contexts.

- **Key Objectives**:
  - Allow users to register and log in securely.
  - Manage roles (e.g., admin, manager) and granular permissions (e.g., "create_product").
  - Support multi-account users (one user can have profiles in multiple companies).
  - Generate JWT tokens with automatic refresh for session management.
  - Enforce multi-tenant security, where data is isolated per company.

For beginners: Think of IAM as the "login door" of the app. Without it, you can't access any protected features. It's like the security guard that checks your ID and decides what rooms you can enter.

## Roles & Permissions (RBAC)

IAM uses a Role-Based Access Control (RBAC) system to define what users can do. Roles are groups of permissions, and permissions are specific actions (e.g., "view_orders").

- **Roles** : Pre-defined groups like "Admin" (full access), "Manager" (create/update), "User" (read-only). You can create custom roles.
- **Permissions** : Fine-grained rights, e.g., "manage_roles" (create/edit roles), "view_profiles" (list user profiles).
- **Multi-tenant Support** : Permissions are scoped to the user's current company profile. A user can switch profiles to change companies and permissions.

Example roles:
- **Admin** : All permissions, including managing users, roles, and companies.
- **Manager** : Can view, create, and update (e.g., manage_catalog, create_order).
- **User** : Limited to view-only (e.g., view_orders, view_catalog).

For beginners: Roles are like job titles (admin is the boss, manager is the supervisor, user is the employee). Permissions are the tasks they can perform. To check your permissions, use GET /v1/auth/me after login.

## Endpoints

IAM has 8 routes for auth, roles, profiles, and user_profiles. Below is a table with details. All protected endpoints require Bearer JWT token in the header.

| Method | URL | Description | Required Params / Body | Example Response | Required Permissions |
| --- | --- | --- | --- | --- | --- |
| POST | /v1/auth/login | Authenticate user and generate JWT token | Body: `{"email": string, "password": string}` | `{"access_token": "eyJ0...", "token_type": "bearer", "expires_in": 3600}` | None (public endpoint) |
| POST | `/v1/auth/signup` | Create a new user account | `{"name": string, "email": string, "roles_id": array<int>, "store_id": int, "extra_permissions": array<string>}` | `{"id": 5, "name": "New User", "email": "new@user.com", "company_id": 1, "permissions": ["create_product"]}` | Bearer token with `manage_users` |
| GET | `/v1/auth/me` | Get current user details | None | `{"id": 1, "name": "Ben", "email": "ben@example.com", "company_id": 1, "permissions": ["manage_roles"]}` | Bearer token (authenticated) |
| GET | `/v1/auth/roles` | List all roles | None | `[{"id": 1, "name": "Admin", "permissions": ["*"]}]` | Bearer token with `view_roles` |
| POST | `/v1/auth/roles` | Create a new role | `{"name": string, "permissions": array<string>}` | `{"id": 4, "name": "Custom Role", "permissions": ["create_product"]}` | Bearer token with `manage_roles` |
| GET | `/v1/auth/profiles` | List user profiles | None | `[{"id": 1, "user_id": 1, "company_id": 1, "roles_id": [1]}]` | Bearer token with `view_profiles` |
| POST | `/v1/auth/profiles` | Create a new user profile | `{"user_id": int, "company_id": int, "roles_id": array<int>}` | `{"id": 2, "user_id": 1, "company_id": 2}` | Bearer token with `manage_profiles` |
| POST | `/v1/auth/user_profiles` | Switch or manage multi-profil | `{"profile_id": int}` | `{"profile_id": 2, "company_id": 2, "permissions": array}` | Bearer token (authenticated) |

For more technical details, see the [API Reference > Authentication](/api-reference/authentication).

## Examples of Use

Let's walk through using the IAM module step by step, as if you're a new developer setting up your first account. We'll use cURL examples, but you can use Postman or any HTTP client. Assume you're working on local (http://localhost:8000).

### Example 1: Connection and Obtaining Token (Login)

This endpoint is the starting point for all authenticated actions. It verifies your email and password, and returns a JWT token that you must use in the "Authorization" header for other requests. The token is like a temporary key to the app – it expires after a time (default 1 hour), so you'll need to refresh or login again if it expires.

**Required** :
- email: Your registered email (must be unique in the system).
- password: Your password (stored hashed for security).

cURL example:
```bash
curl -X POST "http://localhost:8000/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "ben@example.com",
    "password": "password123"
  }'
```

**Expected Response (200 OK)** :
```json
{
  "access_token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwMDAvdjEvYXV0aC9zd2l0Y2gtdXNlci1wcm9maWxlIiwiaWF0IjoxNzcwODE3MDYxLCJleHAiOjE3NzA4MjA2NjEsIm5iZiI6MTc3MDgxNzA2MSwianRpIjoiYm9LZjRjRXlkOFRTaFJROCIsInN1YiI6IjM5V1N2Zkk4UzJ2RW9za3J5bGthY25MVnlYZCIsInBydiI6ImNkMDk3MWMzZGI2MGE5ZWJhYjkwZjFiZTg2YjNhYTc5Y2U5MDk0YzEiLCJ1c2VyX2lkIjoiMzlXU3ZmSThTMnZFb3Nrcnlsa2FjbkxWeVhkIiwidHlwZSI6InVzZXIiLCJjdXJyZW50X3VzZXJfcHJvZmlsZV9pZCI6IjM5V1N2aWRvNkI1ZUNzQzlDQnNlVzNxRDlKaiIsImNvbXBhbnlfaWQiOiIzOVdTdmkyMW9UblpOOGkwMjhZODBGVE5UMXgiLCJwcm9maWxlX2lkIjoiMzlXU3ZsM3FpMll4NEN4Y0p3YzJWYTBlNUZwIiwib3JnYW5pemF0aW9uX2lkIjoiMzlXU3ZkdHRidlFBbzBNalZxcUZCSFFpSmh6In0.wvZ86CIj6TL12OzrBOmlwuWWHEiyVFaOJi_2waXzTC4",
  "token_type": "bearer",
  "expires_in": 3600
}
```

**Explanation of Response Properties** :
- **access_token**: This is the JWT token string you must use in the "Authorization" header for protected endpoints. It encodes your user ID, company ID, and permissions. Example: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...". Copy this value and prefix it with "Bearer " in future requests (e.g., "Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...").
- **token_type**: Always "bearer". This tells you how to use the token (as a Bearer token in headers).
- **expires_in**: Number of seconds until the token expires (e.g., 3600 seconds = 1 hour). After this, you need to login again or use a refresh mechanism (see advanced notes below).

**What This Does** : The server checks your email and password against the database. If correct, it generates a signed JWT token containing your user details and returns it. This token is used to authenticate all subsequent requests. If the credentials are invalid, you'll get a 400 error with "Invalid credentials".

**Beginner Tips** :
- If you forget your password, contact an admin (no reset endpoint in current version).
- Test this endpoint first in Postman: Create a new request, set method to POST, URL to http://localhost:8000/v1/auth/login, add the body as JSON, and send. Copy the access_token from the response for the next steps.
- Common error: 400 Invalid credentials – check if email/password are correct or if the user is registered.

**Advanced Notes** : The token includes multi-tenant info like company_id and organization_id. For refresh, the module supports automatic refresh (not shown in openapi.json; check Laravel code for implementation). Use this token in all other endpoints' headers.

Now, let's continue to the next example in the IAM module. 

### Example 2: Signup (Create a New User Account)

This endpoint allows an authenticated admin or user with "manage_users" permission to create a new user account. It assigns roles, optional store, and extra permissions to the new user. This is useful for onboarding new team members in a company.

**Required** :
- name: The full name of the new user (string, e.g., "John Doe").
- email: The unique email address for the new user (string, must be valid email format, unique in the system).
- roles_id: An array of role IDs to assign to the user (array of integers, e.g., [1, 2] for admin and manager roles).

**Optional** :
- store_id: The ID of the store to associate with the user (integer, if applicable for your company setup).
- extra_permissions: An array of additional permission strings not covered by roles (array of strings, e.g., ["create_custom_report"]).

cURL example:
```bash
curl -X POST "http://localhost:8000/v1/auth/signup" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <your_admin_token>" \
  -d '{
    "name": "New Team Member",
    "email": "newmember@example.com",
    "roles_id": [2, 3],
    "store_id": 1,
    "extra_permissions": ["view_reports", "create_orders"]
  }'
```

**Expected Response (201 Created)** :
```json
{
  "id": 10,
  "name": "New Team Member",
  "email": "newmember@example.com",
  "company_id": 1,
  "permissions": ["view_reports", "create_orders", "other_permissions_from_roles"]
}
```

**Explanation of Response Properties** :
- **id**: The unique integer ID assigned to the new user in the database. Use this ID for future references, like assigning profiles or checking details.
- **name**: The name you provided in the request, echoed back for confirmation.
- **email**: The email you provided, confirmed as registered.
- **company_id**: The ID of the company (tenant) to which the user is assigned. In multi-tenant setups, this is automatically set based on the admin's current company context.
- **permissions**: An array of strings listing all permissions the user has. This combines permissions from the assigned roles (roles_id) and any extra_permissions you specified. Example: ["view_reports", "create_orders", "manage_stock"].

**What This Does** : The server validates the input (e.g., email unique, roles_id exist), creates the user in the database, assigns the roles and permissions, and returns the new user object. The user can now login with a password (set via email or separate endpoint, not shown here). If validation fails (e.g., duplicate email), you'll get a 400 error with details.

**Beginner Tips** :
- Before creating a user, ensure the roles_id exist (use GET /v1/auth/roles to list available roles).
- Test in Postman: Set up a collection, add the Authorization header with an admin token, and send the request. Check the response for the new id.
- Common error: 400 Validation error – check if email is unique or roles_id are valid. If 403 Forbidden, your token doesn't have "manage_users" permission.

**Advanced Notes** : This endpoint integrates with multi-tenant: the new user is tied to the admin's company_id. For multi-company users, use POST /v1/auth/profiles to add profiles in other companies. The token from login will include the user's permissions.

### Example 3: Get Current User (Retrieve Authenticated User Details)

This endpoint returns the details of the currently authenticated user, including their ID, name, email, company context, and full list of permissions. It's useful for debugging, displaying user info in the UI, or checking permissions client-side.

**Required** :
- No body or params – just the Bearer token in the header.

cURL example:
```bash
curl -X GET "http://localhost:8000/v1/auth/me" \
  -H "Authorization: Bearer <your_token>"
```

**Expected Response (200 OK)** :
```json
{
  "id": 1,
  "name": "Ben",
  "email": "ben@example.com",
  "company_id": "39WSvi21oTnZN8i028Y80FTNT1x",
  "permissions": ["manage_roles", "view_orders", "create_product"]
}
```

**Explanation of Response Properties** :
- **id**: The unique integer ID of the user. Use this for referencing in other endpoints (e.g., assigning profiles).
- **name**: The full name of the user, as registered.
- **email**: The email address associated with the user.
- **company_id**: The ID of the current company (tenant) the user is logged into. This is a Ksuid string (e.g., "39WSvi21oTnZN8i028Y80FTNT1x"). In multi-tenant setups, this determines data isolation – all queries are scoped to this company.
- **permissions**: An array of strings listing all effective permissions for the user in this company context. This combines permissions from roles and extra_permissions. Example: ["manage_roles" allows creating roles, "view_orders" allows listing orders].

**What This Does** : The server decodes the JWT token from the header, verifies it, and fetches the user's details from the database, including the current profile's company and permissions. If the token is invalid or expired, you'll get a 401 Unauthorized error.

**Beginner Tips** :
- Use this endpoint right after login to confirm your session and see what you can do (permissions list).
- Test in Postman: Copy your token from the login response, add it to the Authorization header as "Bearer `<token>`", and send the GET request.
- Common error: 401 Unauthorized – token expired or invalid; login again.

**Advanced Notes** : The response includes multi-tenant context (company_id). If the user has multiple profiles, switch with POST /v1/auth/user_profiles to change company_id and permissions. This endpoint is lightweight and can be called often for client-side permission checks.

### Next Steps in IAM

Now that you've mastered login, signup, and getting user details, let's continue with the remaining examples for IAM.

### Example 4: List All Roles (GET /v1/auth/roles)

This endpoint lists all available roles in the system, including their names and associated permissions. It's useful for admins to see what roles exist before assigning them to users.

**Required** :
- No body or params – just the Bearer token in the header.

cURL example:
```bash
curl -X GET "http://localhost:8000/v1/auth/roles" \
  -H "Authorization: Bearer <your_token>"
```

**Expected Response (200 OK)** :
```json
[
  {
    "id": 1,
    "name": "Admin",
    "permissions": ["*"]
  },
  {
    "id": 2,
    "name": "Manager",
    "permissions": ["view_catalog", "create_order", "update_product"]
  },
  {
    "id": 3,
    "name": "User",
    "permissions": ["view_orders", "view_catalog"]
  }
]
```

**Explanation of Response Properties** (array of roles):
- **id**: The unique integer ID of the role. Use this in roles_id when creating users or profiles.
- **name**: The human-readable name of the role (e.g., "Admin").
- **permissions**: An array of strings listing the permissions granted by this role (e.g., ["*"] means all permissions for Admin).

**What This Does** : The server checks your token for "view_roles" permission, then queries the roles table and returns the list. If no roles exist, it returns an empty array.

**Beginner Tips** :
- Use this to get role IDs for signup (roles_id array).
- Test in Postman: Same as /auth/me, but change URL to /v1/auth/roles.
- Common error: 403 Forbidden – you need "view_roles" permission in your current profile.

**Advanced Notes** : Roles are company-scoped in multi-tenant setups. To create custom roles, use POST /v1/auth/roles (next example).

### Example 5: Create a New Role (POST /v1/auth/roles)

This endpoint allows admins to create a new role with specific permissions. It's essential for customizing access control.

**Required** :
- name: The name of the new role (string, e.g., "Custom Manager").
- permissions: An array of permission strings (e.g., ["view_catalog", "create_order"]).

cURL example:
```bash
curl -X POST "http://localhost:8000/v1/auth/roles" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <your_admin_token>" \
  -d '{
    "name": "Custom Manager",
    "permissions": ["view_catalog", "create_order", "update_product"]
  }'
```

**Expected Response (201 Created)** :
```json
{
  "id": 4,
  "name": "Custom Manager",
  "permissions": ["view_catalog", "create_order", "update_product"]
}
```

**Explanation of Response Properties** :
- **id**: The new integer ID assigned to the role. Use this ID in roles_id when assigning to users.
- **name**: The name you provided, echoed back.
- **permissions**: The array of permissions you assigned, confirmed.

**What This Does** : The server validates the input (name unique, permissions valid), creates the role in the database, and returns it. The role can now be assigned to users.

**Beginner Tips** :
- List existing roles first (GET /v1/auth/roles) to avoid duplicates.
- Test in Postman: Add the body as JSON, use an admin token.
- Common error: 400 Validation error – name must be unique; permissions must exist in the system.

**Advanced Notes** : Permissions are strings defined in the code (see config/permission.php). For RBAC, roles can be updated later with PUT /v1/auth/roles/{id} (not in openapi, check code).

### Example 6: List User Profiles (GET /v1/auth/profiles)

This endpoint lists all profiles for users, useful for multi-tenant setups where users have profiles in multiple companies.

**Required** :
- No body or params – just the Bearer token in the header.

cURL example:
```bash
curl -X GET "http://localhost:8000/v1/auth/profiles" \
  -H "Authorization: Bearer <your_token>"
```

**Expected Response (200 OK)** :
```json
[
  {
    "id": 1,
    "user_id": 1,
    "company_id": "39WSvi21oTnZN8i028Y80FTNT1x",
    "roles_id": [1]
  },
  {
    "id": 2,
    "user_id": 1,
    "company_id": "another_company_id",
    "roles_id": [2]
  }
]
```

**Explanation of Response Properties** (array of profiles):
- **id**: The unique integer ID of the profile.
- **user_id**: The ID of the user this profile belongs to.
- **company_id**: The Ksuid of the company for this profile (scopes permissions to this company).
- **roles_id**: Array of role IDs assigned to this profile in the company.

**What This Does** : The server fetches all profiles associated with users (scoped to your permissions), returning the list.

**Beginner Tips** :
- Use this to see multi-company profiles for a user.
- Test in Postman: Simple GET with token.
- Common error: 403 Forbidden – need "view_profiles" permission.

**Advanced Notes** : Profiles allow users to switch companies. Use POST /v1/auth/profiles to create new ones.

### Example 7: Create a New User Profile (POST /v1/auth/profiles)

This endpoint creates a new profile for a user in a specific company, assigning roles.

**Required** :
- user_id: ID of the user (int).
- company_id: Ksuid of the company (string).
- roles_id: Array of role IDs (`array<int>`).


cURL example:
```bash
curl -X POST "http://localhost:8000/v1/auth/profiles" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <your_admin_token>" \
  -d '{
    "user_id": 1,
    "company_id": "39WSvi21oTnZN8i028Y80FTNT1x",
    "roles_id": [1, 2]
  }'
```

**Expected Response (201 Created)** :
```json
{
  "id": 3,
  "user_id": 1,
  "company_id": "39WSvi21oTnZN8i028Y80FTNT1x",
  "roles_id": [1, 2]
}
```

**Explanation of Response Properties** :
- **id**: The new ID of the profile.
- **user_id**: The user ID you provided.
- **company_id**: The company ID you provided.
- **roles_id**: The roles assigned, confirmed.

**What This Does** : Creates a profile linking the user to the company with specific roles.

**Beginner Tips** :
- List companies first (GET /v1/company) for company_id.
- Test in Postman: Use admin token.
- Common error: 400 → user_id or company_id invalid.

**Advanced Notes** : After creating, the user can switch to this profile for company-specific permissions.

### Example 8: Switch or Manage Multi-Profile User (POST /v1/auth/user_profiles)

This endpoint allows switching to a different profile (company context) for the current user.

**Required** :
- profile_id: ID of the profile to switch to (int).

cURL example:
```bash
curl -X POST "http://localhost:8000/v1/auth/user_profiles" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <your_token>" \
  -d '{
    "profile_id": 3
  }'
```

**Expected Response (200 OK)** :
```json
{
  "profile_id": 3,
  "company_id": "39WSvi21oTnZN8i028Y80FTNT1x",
  "permissions": ["manage_roles", "view_orders"]
}
```

**Explanation of Response Properties** :
- **profile_id**: The ID of the new active profile.
- **company_id**: The company now active for the user.
- **permissions**: Updated permissions for the new profile.

**What This Does** : Updates the user's session to the new profile, changing company context and permissions.

**Beginner Tips** :
- List profiles first (GET /v1/auth/profiles) for profile_id.
- Test in Postman: After switch, call GET /v1/auth/me to see updated company_id.
- Common error: 400 → profile_id not belonging to user.

**Advanced Notes** : This enables multi-tenant switching without logout. Token is updated with new company_id.

## Notes for Developers

- **JWT Tokens** : Tokens include user_id, company_id, profile_id, organization_id. Refresh is automatic (check code for implementation).
- **Multi-tenant** : All data is scoped to company_id from the token.
- **Security** : Use HTTPS, validate permissions server-side.
- **Troubleshooting** : 401 → invalid token; 403 → missing permission; 400 → invalid input.
- **Extensions** : Integrate with email verification or password reset (not in current openapi).

## Was this page helpful?

Your feedback helps us improve the documentation.



<div style={{ display: 'flex', gap: '16px', marginTop: '16px' }}>
  <button
    onClick={() => {
      document.getElementById('feedback-yes-message').style.display = 'block';
      document.getElementById('feedback-no-message').style.display = 'none';
      setTimeout(() => {
        document.getElementById('feedback-yes-message').style.display = 'none';
      }, 4000);
    }}
    style={{
      padding: '10px 24px',
      color: '#16A34A',
      border: 'none',
      borderRadius: '8px',
      cursor: 'pointer',
      fontWeight: '600',
      fontSize: '15px',
    }}
  >
    Yes
  </button>

  <button
    onClick={() => {
      document.getElementById('feedback-no-message').style.display = 'block';
      document.getElementById('feedback-yes-message').style.display = 'none';
      setTimeout(() => {
        document.getElementById('feedback-no-message').style.display = 'none';
      }, 4000);
    }}
    style={{
      padding: '10px 24px',
      color: '#e53e3e',
      border: 'none',
      borderRadius: '8px',
      cursor: 'pointer',
      fontWeight: '600',
      fontSize: '15px',
    }}
  >
    No
  </button>
</div>

{/* Message Yes */}
<div 
  id="feedback-yes-message" 
  style={{ 
    display: 'none', 
    marginTop: '20px', 
    padding: '12px 20px', 
    backgroundColor: '#000702d6', 
    borderRadius: '8px', 
    border: 'none', 
    color: '#16A34A', 
    fontSize: '15px', 
    fontWeight: '500',
    textAlign: 'center'
  }}
>
  Thank you! We're glad this helped
</div>

{/* Message No */}
<div 
  id="feedback-no-message" 
  style={{ 
    display: 'none', 
    marginTop: '20px', 
    padding: '12px 20px', 
    backgroundColor: '#130101', 
    borderRadius: '8px', 
    border: 'none', 
    color: '#991b1b', 
    fontSize: '15px', 
    fontWeight: '500',
    textAlign: 'center'
  }}
>
  Thanks for the feedback — we'll improve it!
</div>

```